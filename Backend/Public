<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exam Monitoring Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      color: #333;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 5px;
    }

    .header p {
      opacity: 0.9;
      font-size: 14px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .stat-card h3 {
      color: #666;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 13px;
      color: #888;
    }

    .section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #333;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .live-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: #ff4757;
      color: white;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .live-dot {
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .search-bar {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
    }

    .search-bar input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }

    .search-bar input:focus {
      outline: none;
      border-color: #667eea;
    }

    .search-bar button {
      padding: 12px 24px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }

    .search-bar button:hover {
      background: #5568d3;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    table th {
      background: #f8f9fa;
      padding: 12px;
      text-align: left;
      font-size: 13px;
      font-weight: 600;
      color: #666;
      border-bottom: 2px solid #e0e0e0;
    }

    table td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 14px;
    }

    table tr:hover {
      background: #f8f9fa;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-active {
      background: #d4edda;
      color: #155724;
    }

    .badge-ended {
      background: #f8d7da;
      color: #721c24;
    }

    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }

    .badge-danger {
      background: #f8d7da;
      color: #721c24;
    }

    .severity-0 { color: #28a745; }
    .severity-1 { color: #17a2b8; }
    .severity-2 { color: #ffc107; }
    .severity-3 { color: #fd7e14; }
    .severity-4 { color: #dc3545; }
    .severity-5 { color: #6f42c1; font-weight: bold; }

    .activity-item {
      padding: 12px;
      border-left: 4px solid #667eea;
      background: #f8f9fa;
      margin-bottom: 10px;
      border-radius: 4px;
      font-size: 13px;
    }

    .activity-time {
      color: #888;
      font-size: 11px;
      margin-bottom: 4px;
    }

    .activity-type {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .activity-details {
      color: #666;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #888;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #888;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    #realtimeActivities {
      max-height: 500px;
      overflow-y: auto;
    }

    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filters select {
      padding: 8px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 13px;
    }

    .chart-container {
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üîí Exam Monitoring Dashboard</h1>
    <p>Real-time monitoring and analytics for exam sessions</p>
  </div>

  <div class="container">
    <!-- Statistics -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <h3>Active Sessions</h3>
        <div class="stat-value" id="activeSessions">0</div>
        <div class="stat-label">Currently taking exams</div>
      </div>
      <div class="stat-card">
        <h3>Total Sessions</h3>
        <div class="stat-value" id="totalSessions">0</div>
        <div class="stat-label">All time</div>
      </div>
      <div class="stat-card">
        <h3>Total Activities</h3>
        <div class="stat-value" id="totalActivities">0</div>
        <div class="stat-label">Logged events</div>
      </div>
      <div class="stat-card">
        <h3>Infractions</h3>
        <div class="stat-value" id="totalInfractions" style="color: #dc3545;">0</div>
        <div class="stat-label">Violations detected</div>
      </div>
    </div>

    <!-- Search -->
    <div class="section">
      <div class="section-title">Search Student</div>
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Enter Student ID...">
        <button onclick="searchStudent()">üîç Search</button>
      </div>
      <div id="searchResults"></div>
    </div>

    <!-- Active Sessions -->
    <div class="section">
      <div class="section-title">
        <span>Active Exam Sessions</span>
        <span class="live-indicator">
          <span class="live-dot"></span>
          LIVE
        </span>
      </div>
      <div class="filters">
        <select id="filterStatus" onchange="applyFilters()">
          <option value="all">All Status</option>
          <option value="active" selected>Active Only</option>
          <option value="ended">Ended Only</option>
        </select>
        <select id="filterInfractions" onchange="applyFilters()">
          <option value="all">All Infractions</option>
          <option value="0">No Infractions</option>
          <option value="1">1+ Infractions</option>
          <option value="5">5+ Infractions</option>
        </select>
        <button class="btn btn-primary" onclick="refreshDashboard()">üîÑ Refresh</button>
      </div>
      <div id="activeSessions List">
        <div class="loading">Loading active sessions...</div>
      </div>
    </div>

    <!-- Real-time Activities -->
    <div class="section">
      <div class="section-title">
        <span>Real-time Activity Feed</span>
        <span class="badge badge-warning" id="activityCount">0 new</span>
      </div>
      <div id="realtimeActivities">
        <div class="empty-state">
          <div class="empty-state-icon">üì°</div>
          <p>Waiting for activities...</p>
        </div>
      </div>
    </div>

    <!-- Infraction Statistics -->
    <div class="section">
      <div class="section-title">Infraction Statistics</div>
      <div id="infractionStats">
        <div class="loading">Loading statistics...</div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const API_URL = 'http://localhost:3000/api';
    const socket = io('http://localhost:3000');

    let activityCounter = 0;

    // Initialize dashboard
    async function initDashboard() {
      await loadStats();
      await loadActiveSessions();
      setupWebSocket();
      
      // Auto-refresh every 30 seconds
      setInterval(loadStats, 30000);
      setInterval(loadActiveSessions, 30000);
    }

    // Load statistics
    async function loadStats() {
      try {
        const response = await fetch(`${API_URL}/dashboard/stats`);
        const data = await response.json();
        
        if (data.success) {
          document.getElementById('activeSessions').textContent = data.stats.activeSessions;
          document.getElementById('totalSessions').textContent = data.stats.totalSessions;
          document.getElementById('totalActivities').textContent = data.stats.totalActivities;
          
          const totalInfractions = data.stats.infractionStats.reduce((sum, item) => sum + item.count, 0);
          document.getElementById('totalInfractions').textContent = totalInfractions;
          
          displayInfractionStats(data.stats.infractionStats);
        }
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Load active sessions
    async function loadActiveSessions() {
      try {
        const response = await fetch(`${API_URL}/dashboard/sessions/active`);
        const data = await response.json();
        
        const container = document.getElementById('activeSessionsList');
        
        if (data.sessions.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üë§</div>
              <p>No active exam sessions</p>
            </div>
          `;
          return;
        }
        
        container.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Student ID</th>
                <th>Session ID</th>
                <th>Start Time</th>
                <th>Duration</th>
                <th>Infractions</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${data.sessions.map(session => `
                <tr>
                  <td><strong>${session.studentId}</strong></td>
                  <td><code style="font-size: 11px;">${session.sessionId.substring(0, 20)}...</code></td>
                  <td>${new Date(session.startTime).toLocaleString()}</td>
                  <td>${getSessionDuration(session.startTime)}</td>
                  <td>
                    <span class="badge ${session.totalInfractions > 0 ? 'badge-danger' : 'badge-active'}">
                      ${session.totalInfractions} violations
                    </span>
                  </td>
                  <td>
                    <span class="badge ${session.isActive ? 'badge-active' : 'badge-ended'}">
                      ${session.isActive ? 'Active' : 'Ended'}
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-primary" onclick="viewSessionDetails('${session.sessionId}')">
                      View Details
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        console.error('Error loading sessions:', error);
      }
    }

    // Display infraction statistics
    function displayInfractionStats(stats) {
      const container = document.getElementById('infractionStats');
      
      if (stats.length === 0) {
        container.innerHTML = '<p class="empty-state">No infractions recorded yet ‚úÖ</p>';
        return;
      }
      
      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Infraction Type</th>
              <th>Count</th>
              <th>Percentage</th>
            </tr>
          </thead>
          <tbody>
            ${stats.map(stat => {
              const total = stats.reduce((sum, s) => sum + s.count, 0);
              const percentage = ((stat.count / total) * 100).toFixed(1);
              return `
                <tr>
                  <td><strong>${stat._id || 'Unknown'}</strong></td>
                  <td>${stat.count}</td>
                  <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                      <div style="flex: 1; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                        <div style="width: ${percentage}%; height: 100%; background: #667eea;"></div>
                      </div>
                      <span>${percentage}%</span>
                    </div>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    }

    // Setup WebSocket for real-time updates
    function setupWebSocket() {
      socket.on('connect', () => {
        console.log('‚úÖ Connected to monitoring server');
      });

      socket.on('session_started', (data) => {
        console.log('New session started:', data);
        loadActiveSessions();
        loadStats();
        showNotification(`New exam started: ${data.studentId}`);
      });

      socket.on('session_ended', (data) => {
        console.log('Session ended:', data);
        loadActiveSessions();
        loadStats();
      });

      socket.on('activity_logged', (data) => {
        addActivityToFeed(data);
        activityCounter++;
        document.getElementById('activityCount').textContent = `${activityCounter} new`;
      });

      socket.on('heartbeat', (data) => {
        console.log('Heartbeat:', data.studentId);
      });
    }

    // Add activity to real-time feed
    function addActivityToFeed(activity) {
      const container = document.getElementById('realtimeActivities');
      
      // Remove empty state
      if (container.querySelector('.empty-state')) {
        container.innerHTML = '';
      }
      
      const severityClass = `severity-${activity.severity || 0}`;
      const activityEl = document.createElement('div');
      activityEl.className = 'activity-item';
      activityEl.innerHTML = `
        <div class="activity-time">${new Date(activity.timestamp).toLocaleTimeString()}</div>
        <div class="activity-type ${severityClass}">
          ${activity.type} ${activity.severity >= 4 ? '‚ö†Ô∏è' : ''}
        </div>
        <div class="activity-details">
          <strong>Student:</strong> ${activity.studentId} |
          <strong>Details:</strong> ${activity.details || activity.infractionType || 'No details'}
        </div>
      `;
      
      container.prepend(activityEl);
      
      // Keep only last 50 activities
      while (container.children.length > 50) {
        container.removeChild(container.lastChild);
      }
    }

    // Search student
    async function searchStudent() {
      const query = document.getElementById('searchInput').value.trim();
      const resultsContainer = document.getElementById('searchResults');
      
      if (!query) {
        resultsContainer.innerHTML = '';
        return;
      }
      
      resultsContainer.innerHTML = '<div class="loading">Searching...</div>';
      
      try {
        const response = await fetch(`${API_URL}/dashboard/student/${query}`);
        const data = await response.json();
        
        if (data.success && data.sessions.length > 0) {
          resultsContainer.innerHTML = `
            <div style="margin-top: 20px;">
              <h4>Student: ${data.studentId}</h4>
              <p>Total Sessions: ${data.totalSessions} | Total Infractions: ${data.totalInfractions}</p>
              <table style="margin-top: 15px;">
                <thead>
                  <tr>
                    <th>Session</th>
                    <th>Start Time</th>
                    <th>Duration</th>
                    <th>Infractions</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${data.sessions.map(session => `
                    <tr>
                      <td>${session.sessionId.substring(0, 20)}...</td>
                      <td>${new Date(session.startTime).toLocaleString()}</td>
                      <td>${session.endTime ? getSessionDuration(session.startTime, session.endTime) : 'Ongoing'}</td>
                      <td><span class="badge ${session.totalInfractions > 0 ? 'badge-danger' : 'badge-active'}">${session.totalInfractions}</span></td>
                      <td><button class="btn btn-primary" onclick="viewSessionDetails('${session.sessionId}')">View</button></td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        } else {
          resultsContainer.innerHTML = '<p style="margin-top: 15px; color: #888;">No results found</p>';
        }
      } catch (error) {
        resultsContainer.innerHTML = '<p style="margin-top: 15px; color: #dc3545;">Error searching student</p>';
      }
    }

    // View session details
    async function viewSessionDetails(sessionId) {
      try {
        const response = await fetch(`${API_URL}/dashboard/session/${sessionId}`);
        const data = await response.json();
        
        if (data.success) {
          // Create modal or new page with session details
          alert(`Session Details:\n\nStudent: ${data.session.studentId}\nTotal Activities: ${data.activities.length}\nInfractions: ${data.session.totalInfractions}\n\nSee console for full details.`);
          console.log('Session Details:', data);
        }
      } catch (error) {
        alert('Error loading session details');
      }
    }

    // Utility functions
    function getSessionDuration(startTime, endTime = null) {
      const start = new Date(startTime);
      const end = endTime ? new Date(endTime) : new Date();
      const diff = Math.floor((end - start) / 1000 / 60); // minutes
      return `${diff} min`;
    }

    function refreshDashboard() {
      activityCounter = 0;
      document.getElementById('activityCount').textContent = '0 new';
      loadStats();
      loadActiveSessions();
    }

    function applyFilters() {
      // Implement filtering logic
      loadActiveSessions();
    }

    function showNotification(message) {
      if (Notification.permission === 'granted') {
        new Notification('Exam Monitor', { body: message });
      }
    }

    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', initDashboard);
  </script>
</body>
</html>
